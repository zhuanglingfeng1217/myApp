<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="css/imageviewer.css" />
		<style type="text/css">
			* {
				box-sizing: border-box;
				padding: 0;
				margin: 0;
			}
			.msg_box{
				margin-top: 15px;
			}
			.right_icon {
				float: right;
			}
			
			.mui-bar .record {
				border: 1px solid #333333;
				width: 30px;
				height: 30px;
				border-radius: 50%;
				padding: 0;
				margin-left: 10px;
				margin-top: 10px;
				text-align: center;
				padding-top: 2px;
			}
			
			#user_text {
				width: 75%;
				border: none;
				border-bottom: 1px solid #ccc;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
			}
			
			#user_text:focus {
				border-bottom: 1px solid lawngreen;
			}
			
			.mic_box,
			.plus_box {
				display: inline-block;
				width: 12.5%;
			}
			
			.left_text {
				float: left;
				width: 80%;
				margin-bottom: 5px;
			}
			
			.right_text {
				float: right;
				width: 80%;
				margin-bottom: 5px;
			}
			
			.head_img {
				width: 40px;
				height: 40px;
			}
			
			.head_img>img {
				width: 40px;
				height: 40px;
			}
			
			.left_text .head_img,
			.left_text .user_msg {
				float: left;
				/*text-align: left;*/
			}
			.left_text .user_msg{
				margin-left: 10px;
			}
			
			.user_msg {
				min-height: 40px;
				border-radius: 5px;
				max-width: 80%;
				background-color: mediumspringgreen;
				display: table;
				padding: 10px;
				position: relative;
			}
			
			.user_msg span {
				vertical-align: middle;
				display: table-cell;
				word-break: break-all;
			}
			
			.right_text .head_img,
			.right_text .user_msg {
				float: right;
				right: 10px;
				/*text-align: right;*/
			}
			
			.right_text .playAudio {
				display: inline-block;
				width: 40px;
				height: 40px;
				background-image: url(img/bg_record_icon.png);
				background-repeat: no-repeat;
				background-size: contain;
				background-position: 0 4px;
			}
			
			.user_msg>i {
				width: 0;
				height: 0;
				border-top: 5px solid transparent;
				border-bottom: 5px solid transparent;
				position: absolute;
				top: 15px;
			}
			
			.right_text .user_msg>i {
				border-left: 10px solid mediumspringgreen;
				right: -10px;
			}
			.left_text .user_msg>i {
				border-right: 10px solid mediumspringgreen;
				left: -10px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav mui-clearfix">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">chat</h1>
			<span class="mui-icon mui-icon-person right_icon"></span>
		</header>
		<nav class="mui-bar mui-bar-tab" style="height: 40px;">
			<div class="mic_box">
				<span class="record mui-icon mui-icon-mic"></span>
			</div>

			<input type="text" id="user_text" />
			<div class="plus_box">
				<a class="mui-icon mui-icon-plus add_file" id="openSheet" href="#sheet" style="font-size: 35px;color: inherit;"></a>
				<span class="send" style="display: none;">发送</span>
			</div>

		</nav>
		<div class="mui-content" >
			<div class="mui-scroll-wrapper" style="top:44px;bottom: 67px;">
			    <div class="mui-scroll">
			        <!--这里放置真实显示的DOM内容-->
			        <ul class="mui-table-view mui-clearfix msg_box">
				<li class="left_text mui-clearfix">
					<div class="head_img">
						<img src="img/images3.png" data-preview-src="" data-preview-group="1" />
					</div>
					<div class="user_msg">
						<span>来数李径独来数</span>
						<i></i>
					</div>
				</li>
				<li class="right_text mui-clearfix">
					<div class="head_img">
						<img src="img/images2.jpg" data-preview-src="" data-preview-group="1" />
					</div>
					<div class="user_msg">
						<span>nihao李径独来数李径独来数李径独来数李径独来数李径独来数李径独来数</span>
						<i></i>
					</div>
				</li>
				<!--<li class="right_text">
					<div class="head_img">
						<img src="img/images2.jpg" />
					</div>
					<div class="user_msg">
						<span class="playAudio">1234</span>
					</div>
				</li>-->
			</ul>
			    </div>
			</div>
			
			
		</div>
		<div id="sheet" class="mui-popover mui-popover-bottom mui-popover-action ">
			<!-- 可选择菜单 -->
			<ul class="mui-table-view">
				<li class="mui-table-view-cell" id="openCamera">
					<span>拍照</span>
				</li>
				<li class="mui-table-view-cell" id="openImg">
					<span>相册</span>
				</li>
			</ul>
			<!-- 取消菜单 -->
			<!--<ul class="mui-table-view">
		      <li class="mui-table-view-cell">
		        <a href="#sheet1"><b>取消</b></a>
		      </li>
		    </ul>-->
		</div>
		<!--<a href="#sheet" id="openSheet" class="mui-btn mui-btn-primary mui-btn-block">打开操作表</a>-->

		<script src="js/mui.min.js"></script>
		<script src="js/mui.zoom.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.previewimage.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/jquery-1.8.0.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/template.js" type="text/javascript" charset="utf-8"></script>
		<!--纯文本模板-->
		<script type="text/javascript" id="msgList">
			<li class="{{user}} mui-clearfix">
				<div class="head_img">
					<img src="img/images2.jpg"/>
				</div>
				<div class="user_msg">
					<span>{{text}}</span>
					<i></i>
				</div>
			</li>
		</script>
		<!--图像模板-->
		<script type="text/javascript" id="imgList">
			<li class="{{user}} mui-clearfix">
				<div class="head_img">
					<img src="img/images2.jpg"/>
				</div>
				<div class="user_msg">
					<img src={{url}} style="width:120px;height:120px;" data-preview-src="" data-preview-group="1" />
					<i></i>
				</div>
			</li>
		</script>
		<!--录音模板-->
		<script type="text/javascript" id="recordList">
			<li class="{{user}} mui-clearfix">
				<div class="head_img">
					<img src="img/images2.jpg"/>
				</div>
				<div class="user_msg">
					<span class="playAudio" data-url={{url}}></span>
				</div> 
			</li>
		</script>
	
		<script type="text/javascript">
			mui.previewImage();
			$(function(){
//				localStorage.setItem('msgList','');
//				var mList = [{recordList:[{url:'123',user:'right_text'}]},{textList:[{text:'111',user:'right_text'}]},{imgList:[{url:'img/images.jpg',user:'right_text'}]}];
//				localStorage.setItem('msgList',JSON.stringify(mList));
				/*初始化滚动区域*/
				mui('.mui-scroll-wrapper').scroll({
					deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
				});
				var msgList = localStorage.getItem('msgList');
				if(msgList){
					msgList = JSON.parse(msgList);
					for(var i=0;i<msgList.recordList.length;i++){
						var html = template("recordList",msgList.recordList[i]);
						$(".msg_box").append(html);
					}
					for(var i=0;i<msgList.textList.length;i++){
						var html = template("msgList",msgList.textList[i]);
						$(".msg_box").append(html);
					}
					for(var i=0;i<msgList.imgList.length;i++){
						var html = template("imgList",msgList.imgList[i]);
						$(".msg_box").append(html);
					}
				}
				mui('.mui-scroll-wrapper').scroll().scrollToBottom(100);
			});
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				}
			});
			var r = null;
			/*播放录音文件*/
			$('body').on('tap', '.playAudio', function() {
				var url = $(this).attr('data-url');
				startPlay(url);
			})

			function startPlay(url) {
				var p = plus.audio.createPlayer(url);
				if(p == null) {
					mui.toast("播放失败" + p);
				}
				// 切换到听筒线路
				//				p.setRoute(plus.audio.ROUTE_EARPIECE);
				p.setRoute(plus.audio.ROUTE_SPEAKER);
				p.play(function() {
					mui.toast('播放中');
				}, function(e) {
					mui.alert('播放音频' + url + '失败:' + e.message);
				})
			}
			mui.plusReady(function() {
				plus.webview.currentWebview().setStyle({
					softinputMode:'adjustResize'
				})
				console.log(r);
				/*长按录音 松开停止录音*/
				$('.record').on('longtap', function(e) {
					mui.toast('录音开始');
					r = plus.audio.getRecorder();
					if(r == null) {
						mui.alert('录音对象未获取');
						return;
					}
					r.record({
						filename: '_doc/myaudio/'
					}, function(p) {
						mui.toast('录音完成' + p);
						plus.io.resolveLocalFileSystemURL(p, function(entry) {
							mui.toast('读取文件成功');
							var li = '<li class="right_text mui-clearfix">' +
								'<div class="head_img">' +
								'<img src="img/images2.jpg"/>' +
								'</div>' +
								'<div class="user_msg">' +
								'<span class="playAudio" data-url=' + p + '></span>' +
								'</div>' +
								'</li>'
							$(".msg_box").append(li);
							var msgList = localStorage.getItem('msgList');
							if(msgList){
								msgList = JSON.parse(msgList);
							}else{
								msgList = {recordList:[],imgList:[],textList:[]};
							}
							var recordObj = {};
							recordObj.url = p;
							recordObj.user = 'right_text';
							msgList.recordList.push(recordObj);
							msgList = JSON.stringify(msgList);
							localStorage.setItem('msgList',msgList);
						}, function(e) {
							mui.alert('读取录音文件错误');
						})
					}, function(e) {
						mui.alert('录音失败' + e.message);
					})
				}).on('release', function() {
					r.stop();
					mui.toast('停止录音');
				});
				/*打开摄像头*/
				$("#openCamera").on('tap', function() {
					var cmr = plus.camera.getCamera();
					var res = cmr.supportedImageResolutions[0];
					var fmt = cmr.supportedImageFormats[0];
					console.log("Resolution: " + res + ", Format: " + fmt);
					cmr.captureImage(function(p) {
						mui.alert("Capture image success: " + p);
						plus.io.resolveLocalFileSystemURL(p, function(entry) {

						}, function(error) {
							mui.alert(error.message);
						});
						var data = {user:'right_text',url:"http://localhost:13131/"+p};
						var html = template("imgList",data);
						$(".msg_box").append(html);
						var msgList = localStorage.getItem('msgList');
						if(msgList){
							msgList = JSON.parse(msgList);
						}else{
							msgList = {recordList:[],imgList:[],textList:[]};
						}
						var imgObj = {};
						imgObj.url = "http://localhost:13131/"+p;
						imgObj.user = 'right_text';
						msgList.imgList.push(imgObj);
						msgList = JSON.stringify(msgList);
						localStorage.setItem('msgList',msgList);
					}, function(error) {
						mui.alert("Capture image failed: " + error.message);
					}, {
						resolution: res,
						format: fmt
					});
				});
				/*打开相册*/
				$("#openImg").on('tap', function() {
					console.log('openImg');
					var msgList = localStorage.getItem('msgList');
					if(msgList){
						msgList = JSON.parse(msgList);
					}else{
						msgList = {recordList:[],imgList:[],textList:[]};
					}
					plus.gallery.pick(function(e) {
						for(var i in e.files){
							console.log(e.files[i]);
							var data = {user:'right_text',url:e.files[i]};
							var html = template("imgList",data);
							$(".msg_box").append(html);
							var imgObj = {};
							imgObj.url = e.files[i];
							imgObj.user = 'right_text';
							msgList.imgList.push(imgObj);
						}
						msgList = JSON.stringify(msgList);
						localStorage.setItem('msgList',msgList);
						console.log(path);
					}, function() {
						console.log('取消选择照片');
					}, {
						filter: "image",
						multiple:true,
					})
				});
			})
			/*监听输入框*/
			$('#user_text').on('input', function() {
				if($("#user_text").val()) {
					$('.add_file').hide();
					$('.send').show();
				} else {
					$('.add_file').show();
					$('.send').hide();
				}
			})
			/*发送*/
			$('.send').on('tap', function() {
				var msg = $('#user_text').val();
				var data = {
					text: msg,
					user:'right_text'
				};
				var html = template('msgList', data);
				$('.msg_box').append(html);
				mui('.mui-scroll-wrapper').scroll().scrollToBottom(100);
				var msgList = localStorage.getItem('msgList');
				if(msgList){
					msgList = JSON.parse(msgList);
				}else{
					msgList = {recordList:[],imgList:[],textList:[]};
				}
				var textObj = {};
				textObj.text = msg;
				textObj.user = 'right_text';
				msgList.textList.push(textObj);
				msgList = JSON.stringify(msgList);
				localStorage.setItem('msgList',msgList);
				$('#user_text').val('');
				$('.add_file').show();
				$('.send').hide();
			})
			/**/
		</script>
	</body>

</html>